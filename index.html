<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Would You Rather? Music</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; }
        .game-container { display: flex; flex-direction: row; width: 100%; height: 100%; position: relative; }
        
        .divider { width: 2px; height: 100%; background-color: #282828; position: absolute; top: 0; left: 50%; transform: translateX(-50%); z-index: 2; opacity: 0.6; border: none; }
        .vs-circle { width: 100px; height: 100px; background-color: black; border-radius: 50%; color: white; font-size: 48px; font-weight: bold; display: flex; justify-content: center; align-items: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3; border: 5px solid white; }
        .side { width: 50%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out; }
        .side.left { background-color: #007BFF; }
        .side.right { background-color: #E60023; }
        
        .side::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 0;
        }
        .game-container.choices-active .side:hover::after { 
            opacity: 1; 
        }
        
        .game-container.choices-active .side:hover .song-content {
             transform: scale(1.05) translateY(-5px);
        }
        .game-container.choices-active:hover .side:not(:hover) .song-content {
            filter: blur(2px);
            transform: scale(0.95);
            opacity: 0.8;
        }

        .song-content { text-align: center; color: white; position: relative; z-index: 1; opacity: 0; transform: scale(0.8); transition: opacity 0.4s ease-out, transform 0.4s ease-out, filter 0.3s ease-in-out; }
        .song-content.visible { opacity: 1; transform: scale(1); }
        
        .side.playing .song-content,
        .side.winner .song-content { 
            transform: scale(1.05); 
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5)); 
        }
        
        .side.loser .song-content { opacity: 0.6; transform: scale(0.95); }
        .album-cover { width: 300px; height: 300px; object-fit: cover; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; background-color: #333; }
        .song-title { font-size: 28px; font-weight: bold; }
        .song-artist { font-size: 18px; }
        .approval-rating { font-size: 22px; font-weight: bold; margin-top: 15px; color: white; opacity: 0; transition: opacity 0.5s ease-in; }
        #start-button, #next-round-button { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 15px 30px; font-size: 20px; font-weight: bold; color: white; background-color: #1DB954; border: none; border-radius: 30px; cursor: pointer; z-index: 5; }
        #next-round-button { display: none; }
        
        .replay-button {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none; border-radius: 50%; cursor: pointer;
            z-index: 4; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, background-color 0.2s, bottom 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .replay-button.visible { opacity: 1; visibility: visible; }
        .replay-button.result-visible { bottom: 80px; }
        .replay-button svg { width: 24px; height: 24px; }
        .replay-button.cooldown { background-color: rgba(255, 255, 255, 0.4); cursor: not-allowed; }
        
        @media (hover: hover) { 
            .replay-button:not(.cooldown):hover { 
                background-color: rgba(255, 255, 255, 0.85);
            } 
        }
        @media (hover: none) { 
            .replay-button.visible:not(.cooldown) { 
                /* Animação removida para ser mais sutil */
            } 
        }
        
        .switch-container { display: flex; align-items: center; justify-content: space-between; padding: 1.1vh 0; }
        .switch-container span { font-size: 1.8vh; color: #b3b3b3; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #535353; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
        .slider.round { border-radius: 24px; }
        .slider.round:before { border-radius: 50%; }
        input:checked + .slider { background-color: #1DB954; }
        input:checked + .slider:before { transform: translateX(20px); }

        @media (max-width: 768px) and (orientation: portrait) {
            .game-container { flex-direction: column; }
            .side { width: 100%; height: 50%; }
            .divider { width: 100%; height: 2px; top: 50%; left: 0; transform: translateY(-50%); }
            .vs-circle { width: 60px; height: 60px; font-size: 28px; border-width: 3px; }
            .album-cover { width: 120px; height: 120px; margin-bottom: 10px; }
            .song-title { font-size: 18px; }
            .song-artist { font-size: 14px; }
            .approval-rating { font-size: 16px; margin-top: 8px; }
            #start-button, #next-round-button { font-size: 16px; padding: 10px 20px; bottom: 20px; }
            .replay-button { width: 40px; height: 40px; bottom: 20px; }
            .replay-button svg { width: 20px; height: 20px; }
            .replay-button.result-visible { bottom: 60px; }
        }
        
        #menu-toggle { position: absolute; top: 20px; left: 20px; z-index: 10; cursor: pointer; background: none; border: none; padding: 10px; }
        #menu-toggle .bar { display: block; width: 30px; height: 3px; background-color: white; margin: 6px 0; transition: 0.4s; }
        #side-menu {
            position: fixed; top: 0; left: 0; height: 100%; width: 250px; background-color: #181818; z-index: 1000;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding: 2.2vh 20px;
            box-sizing: border-box; color: white; display: flex; flex-direction: column; overflow: hidden;
        }
        #side-menu.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .menu-section h2 { margin-top: 2.2vh; margin-bottom: 1.1vh; font-size: 2vh; color: #fff; border-bottom: 1px solid #444; padding-bottom: 0.9vh;}
        .menu-section:first-child h2 { margin-top: 4.4vh; }
        #side-menu ul { list-style: none; padding: 0; margin: 0;}
        #side-menu ul li a { color: #b3b3b3; text-decoration: none; font-size: 1.8vh; padding: 1.3vh 10px; display: block; transition: color 0.2s, background-color 0.2s; border-radius: 5px; }
        #side-menu ul li a:hover { color: white; background-color: #282828; }
        #side-menu ul li a.selected { color: white; font-weight: bold; background-color: #333; }
        .deezer-credit { margin-top: auto; font-size: 1.3vh; color: #888; padding-top: 2.2vh; }
        .deezer-credit img { height: 2.2vh; }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        #menu-overlay.visible { opacity: 1; visibility: visible; }
        #menu-title-replay, #menu-title-volume, #menu-title-language { color:#b3b3b3; font-size: 1.5vh; margin-top: 1.6vh; }
        .volume-control { display: flex; align-items: center; padding: 1.1vh 0; }
        .volume-icon { margin-right: 15px; font-size: 2.2vh; }
        .volume-value { margin-left: 15px; font-size: 1.8vh; min-width: 25px; text-align: right; }
        .volume-slider-container { flex-grow: 1; }
        #volume-slider { width: 100%; -webkit-appearance: none; background: transparent; }
        #volume-slider::-webkit-slider-runnable-track { width: 100%; height: 5px; cursor: pointer; background: #535353; border-radius: 5px; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; cursor: pointer; margin-top: -5.5px; }

        @media (max-width: 1024px) {
            #side-menu { overflow-y: auto; padding: 20px; }
            .menu-section h2 { font-size: 18px; margin-top: 20px; margin-bottom: 10px; padding-bottom: 8px;}
            .menu-section:first-child h2 { margin-top: 40px; }
            #side-menu ul li a { font-size: 16px; padding: 12px 10px; }
            #menu-title-replay, #menu-title-volume, #menu-title-language { font-size: 14px; margin-top: 15px; }
            .volume-control { padding: 10px 0; }
            .volume-icon { font-size: 20px; }
            .volume-value { font-size: 16px; }
            .switch-container span { font-size: 16px; }
            .deezer-credit { font-size: 12px; padding-top: 20px; margin-top: 20px; }
            .deezer-credit img { height: 20px; }
            #side-menu { scrollbar-width: thin; }
            #side-menu::-webkit-scrollbar { display: block; width: 8px; }
            #side-menu::-webkit-scrollbar-track { background: #181818; }
            #side-menu::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; }
        }

        @media (max-width: 768px) { #side-menu { width: 70%; } }
    </style>
</head>
<body>
    <button id="menu-toggle">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </button>

    <nav id="side-menu">
        <div class="menu-section">
            <h2 id="menu-title-mode">Modo de Jogo</h2>
            <ul id="game-modes-list">
                <li><a href="#" data-mode="geral">Geral</a></li>
                <li><a href="#" data-mode="pop">Pop</a></li>
                <li><a href="#" data-mode="rock">Rock</a></li>
                <li><a href="#" data-mode="rap">Rap</a></li>
                <li><a href="#" data-mode="eletronica">Eletrônica</a></li>
                <li><a href="#" data-mode="classica">Clássica</a></li>
            </ul>
        </div>
        <div class="menu-section">
            <h2 id="menu-title-options">Opções</h2>
            <h3 id="menu-title-replay">Botões de Repetição</h3>
            <div class="switch-container">
                <span id="replay-status-text">Desativado</span>
                <label class="switch">
                    <input type="checkbox" id="replay-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <h3 id="menu-title-volume">Volume</h3>
            <div class="volume-control">
                <span class="volume-icon">🔊</span>
                <div class="volume-slider-container">
                    <input type="range" min="0" max="100" value="100" id="volume-slider">
                </div>
                <span class="volume-value" id="volume-value-display">100</span>
            </div>
            <h3 id="menu-title-language">Idioma</h3>
            <ul id="lang-switcher">
                <li><a href="#" data-lang="en">English</a></li>
                <li><a href="#" data-lang="es">Español</a></li>
                <li><a href="#" data-lang="fr">Français</a></li>
                <li><a href="#" data-lang="pt">Português</a></li>
            </ul>
        </div>
        <div class="deezer-credit">
            <p>Music data provided by</p>
            <a href="https://www.deezer.com" target="_blank" rel="noopener noreferrer">
                <img src="/static/Horizontal-cw-rgb.png" alt="Deezer Logo">
            </a>
        </div>
    </nav>
    <div id="menu-overlay"></div>

    <div class="game-container" id="game-container">
        <div class="side left" id="side-left">
            <div class="song-content" id="song-left">
                <img class="album-cover" id="cover-left" alt="">
                <h2 class="song-title" id="title-left"></h2>
                <p class="song-artist" id="artist-left"></p>
                <div class="approval-rating" id="approval-left"></div>
            </div>
            <button class="replay-button" id="replay-left">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 4V10H10" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20 20V14H14" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20.49 9C19.89 7.98 19.01 7.1 17.94 6.42C16.88 5.73 15.68 5.29 14.45 5.13C13.22 4.98 11.97 5.12 10.8 5.54C9.63 5.96 8.55 6.64 7.64 7.55L4 10" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.51 15C4.11 16.02 4.99 16.9 6.06 17.58C7.12 18.27 8.32 18.71 9.55 18.87C10.78 19.02 12.03 18.88 13.2 18.46C14.37 18.04 15.45 17.36 16.36 16.45L20 14" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="vs-circle" id="vs-circle">VS</div>
        <div class="side right" id="side-right">
            <div class="song-content" id="song-right">
                <img class="album-cover" id="cover-right" alt="">
                <h2 class="song-title" id="title-right"></h2>
                <p class="song-artist" id="artist-right"></p>
                <div class="approval-rating" id="approval-right"></div>
            </div>
            <button class="replay-button" id="replay-right">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 4V10H10" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20 20V14H14" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20.49 9C19.89 7.98 19.01 7.1 17.94 6.42C16.88 5.73 15.68 5.29 14.45 5.13C13.22 4.98 11.97 5.12 10.8 5.54C9.63 5.96 8.55 6.64 7.64 7.55L4 10" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.51 15C4.11 16.02 4.99 16.9 6.06 17.58C7.12 18.27 8.32 18.71 9.55 18.87C10.78 19.02 12.03 18.88 13.2 18.46C14.37 18.04 15.45 17.36 16.36 16.45L20 14" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    <button id="start-button"></button>
    <button id="next-round-button"></button>
    
    <audio id="audio-player"></audio>

    <script>
    const translations = {
        "pt": { menu_replay: "Botões de Repetição", replay_on: "Ativado", replay_off: "Desativado", menu_mode: "Modo de Jogo", menu_options: "Opções", menu_volume: "Volume", menu_language: "Idioma", lang_code: "pt-br", start_game: "▶ Iniciar Jogo", next_round: "Próxima Rodada", approval_of: "Aprovação de", vs: "VS", approval_error: "Aprovação: Tente Novamente", error_loading_songs: "Não foi possível carregar as músicas.", mode_geral: "Geral", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Eletrônica", mode_classica: "Clássica" },
        "en": { menu_replay: "Replay Buttons", replay_on: "Enabled", replay_off: "Disabled", menu_mode: "Game Mode", menu_options: "Options", menu_volume: "Volume", menu_language: "Language", lang_code: "en", start_game: "▶ Start Game", next_round: "Next Round", approval_of: "Approval Rating", vs: "VS", approval_error: "Approval: Try Again Later", error_loading_songs: "Couldn't load songs.", mode_geral: "General", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Electronic", mode_classica: "Classical" },
        "es": { menu_replay: "Botones de Repetición", replay_on: "Activado", replay_off: "Desactivado", menu_mode: "Modo de Juego", menu_options: "Opciones", menu_volume: "Volumen", menu_language: "Idioma", lang_code: "es", start_game: "▶ Iniciar Juego", next_round: "Siguiente Ronda", approval_of: "Índice de Aprobación", vs: "VS", approval_error: "Aprobación: Inténtalo más tarde", error_loading_songs: "No se pudieron cargar las canciones.", mode_geral: "General", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Electrónica", mode_classica: "Clásica" },
        "fr": { menu_replay: "Boutons Répéter", replay_on: "Activé", replay_off: "Désactivé", menu_mode: "Mode de jeu", menu_options: "Options", menu_volume: "Volume", menu_language: "Langue", lang_code: "fr", start_game: "▶ Démarrer le jeu", next_round: "Tour suivant", approval_of: "Taux d'approbation", vs: "VS", approval_error: "Approbation : Réessayez plus tard", error_loading_songs: "Impossible de charger les chansons.", mode_geral: "Général", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Électronique", mode_classica: "Classique" }
    };

    let currentTexts = {};
    const gameContainer = document.getElementById("game-container");
    const startButton = document.getElementById("start-button");
    const nextRoundButton = document.getElementById("next-round-button");
    const vsCircle = document.getElementById("vs-circle");
    const menuTitleMode = document.getElementById("menu-title-mode");
    const menuTitleOptions = document.getElementById("menu-title-options");
    const menuTitleVolume = document.getElementById("menu-title-volume");
    const menuTitleLanguage = document.getElementById("menu-title-language");
    const menuToggle = document.getElementById('menu-toggle');
    const sideMenu = document.getElementById('side-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const langSwitcher = document.getElementById('lang-switcher');
    const sideLeft = document.getElementById("side-left");
    const sideRight = document.getElementById("side-right");
    const songLeft = document.getElementById("song-left");
    const songRight = document.getElementById("song-right");
    const approvalLeft = document.getElementById("approval-left");
    const approvalRight = document.getElementById("approval-right");
    const gameModesList = document.getElementById('game-modes-list');
    const volumeSlider = document.getElementById('volume-slider');
    const volumeValueDisplay = document.getElementById('volume-value-display');
    const replayLeftButton = document.getElementById('replay-left');
    const replayRightButton = document.getElementById('replay-right');
    const replayToggle = document.getElementById('replay-toggle');
    const replayStatusText = document.getElementById('replay-status-text');
    const menuTitleReplay = document.getElementById('menu-title-replay');

    let currentSongs = {};
    let roundOver = false;
    let isChoiceEnabled = false;
    let isReplayActive = false;
    let replayButtonsEnabled = false;
    let currentGameMode = 'geral'; 
    let currentVolume = 1.0;
    let revealTimeoutId = null;

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContext();
    let currentAudioSource = null;
    let currentGainNode = null;
    let preloadedAudio = {};

    function preloadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }

    function preloadAudio(url) {
        if (!url) return Promise.resolve(null);
        return fetch(url)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer));
    }
    
    function playAudio(song, durationInSeconds, audioBuffer) {
        if (currentAudioSource) {
            try { currentAudioSource.stop(); } catch (e) {}
        }
        if (!song || !audioBuffer) return;

        currentAudioSource = audioContext.createBufferSource();
        currentGainNode = audioContext.createGain();
        currentAudioSource.buffer = audioBuffer;
        currentAudioSource.connect(currentGainNode);
        currentGainNode.connect(audioContext.destination);
        
        const startOffset = song.startOffset || 0;
        const initialVolume = currentVolume;

        currentGainNode.gain.setValueAtTime(0, audioContext.currentTime);
        currentGainNode.gain.linearRampToValueAtTime(initialVolume, audioContext.currentTime + 1);
        currentAudioSource.start(audioContext.currentTime, startOffset);

        const fadeOutTime = audioContext.currentTime + durationInSeconds - 1;
        currentGainNode.gain.setValueAtTime(initialVolume, fadeOutTime);
        currentGainNode.gain.linearRampToValueAtTime(0, fadeOutTime + 1);
        currentAudioSource.stop(fadeOutTime + 1.1);
    }

    function setLanguage(lang) {
        currentTexts = translations[lang] || translations['pt'];
        document.documentElement.lang = currentTexts.lang_code;
        startButton.innerText = currentTexts.start_game;
        nextRoundButton.innerText = currentTexts.next_round;
        vsCircle.innerText = currentTexts.vs;
        menuTitleMode.innerText = currentTexts.menu_mode;
        menuTitleOptions.innerText = currentTexts.menu_options;
        menuTitleVolume.innerText = currentTexts.menu_volume;
        menuTitleLanguage.innerText = currentTexts.menu_language;
        menuTitleReplay.innerText = currentTexts.menu_replay;
        updateReplayStatusText();

        document.querySelectorAll('#game-modes-list a').forEach(link => {
            const mode = link.dataset.mode;
            const translationKey = `mode_${mode}`;
            if (currentTexts[translationKey]) {
                link.innerText = currentTexts[translationKey];
            }
        });
    }
    
    function updateReplayStatusText() {
        replayStatusText.innerText = replayToggle.checked ? currentTexts.replay_on : currentTexts.replay_off;
    }
    
    function updateSelectedModeUI() {
        document.querySelectorAll('#game-modes-list a').forEach(a => {
            if (a.dataset.mode === currentGameMode) {
                a.classList.add('selected');
            } else {
                a.classList.remove('selected');
            }
        });
    }

    function toggleMenu() {
        sideMenu.classList.toggle('open');
        menuOverlay.classList.toggle('visible');
    }

    async function startRound() {
        clearTimeout(revealTimeoutId);
        roundOver = false;
        isChoiceEnabled = false;
        isReplayActive = false;
        preloadedAudio = {};
        nextRoundButton.style.display = "none";
        songLeft.classList.remove("visible");
        songRight.classList.remove("visible");
        sideLeft.classList.remove("winner", "loser", "playing");
        sideRight.classList.remove("winner", "loser", "playing");
        approvalLeft.style.opacity = 0;
        approvalRight.style.opacity = 0;
        gameContainer.classList.remove('choices-active');
        replayLeftButton.classList.remove('visible', 'result-visible', 'cooldown');
        replayRightButton.classList.remove('visible', 'result-visible', 'cooldown');

        try {
            const response = await fetch(`https://wouldyourathermusic.pythonanywhere.com/get-songs?mode=${currentGameMode}`);
            const data = await response.json();
            if (data.error) {
                return alert(currentTexts.error_loading_songs);
            }
            currentSongs.left = data[0];
            currentSongs.right = data[1];
            
            prepareSide("left", currentSongs.left);
            prepareSide("right", currentSongs.right);

            const [ leftImage, leftAudioBuffer, rightImage, rightAudioBuffer ] = await Promise.all([
                preloadImage(currentSongs.left.cover),
                preloadAudio(currentSongs.left.preview),
                preloadImage(currentSongs.right.cover),
                preloadAudio(currentSongs.right.preview)
            ]);
            preloadedAudio.left = leftAudioBuffer;
            preloadedAudio.right = rightAudioBuffer;

            if (roundOver) return;
            
            songLeft.classList.add("visible");
            sideLeft.classList.add("playing");
            playAudio(currentSongs.left, 5, preloadedAudio.left);

            revealTimeoutId = setTimeout(() => {
                if (roundOver) return;
                sideLeft.classList.remove("playing");
                
                songRight.classList.add("visible");
                sideRight.classList.add("playing");
                playAudio(currentSongs.right, 5, preloadedAudio.right);
                
                revealTimeoutId = setTimeout(() => {
                    if (roundOver) return;
                    sideRight.classList.remove("playing");
                    isChoiceEnabled = true; 
                    gameContainer.classList.add('choices-active');
                    if (replayButtonsEnabled) {
                        replayLeftButton.classList.add('visible');
                        replayRightButton.classList.add('visible');
                    }
                }, 5000);

            }, 5200);

        } catch (error) {
            console.error("Não foi possível buscar ou pré-carregar os recursos:", error);
            alert(currentTexts.error_loading_songs);
        }
    }

    function prepareSide(side, song) {
        const coverEl = document.getElementById(`cover-${side}`);
        coverEl.src = song.cover;
        coverEl.alt = `Capa do álbum ${song.title} de ${song.artist}`;
        document.getElementById(`title-${side}`).innerText = song.title;
        document.getElementById(`artist-${side}`).innerText = song.artist;
    }
    
    function animateApprovalRating(element, finalValue) {
        element.style.opacity = 1;
        let startValue = 0;
        const duration = 1000;
        const stepTime = 20;
        const steps = duration / stepTime;
        let increment = finalValue === 0 ? 0 : finalValue / steps;
        
        element.innerText = `${currentTexts.approval_of} 0%`;
        if (finalValue === 0) return;

        const timer = setInterval(() => {
            startValue += increment;
            if (startValue >= finalValue) {
                startValue = finalValue;
                clearInterval(timer);
            }
            element.innerText = `${currentTexts.approval_of} ${Math.floor(startValue)}%`;
        }, stepTime);
    }

    async function handleChoice(side) {
        if (!roundOver && isChoiceEnabled) {
            roundOver = true;
            isChoiceEnabled = false;
            gameContainer.classList.remove('choices-active');
            replayLeftButton.classList.remove('visible');
            replayRightButton.classList.remove('visible');
            
            const winnerSong = currentSongs[side];
            const loserSide = "left" === side ? "right" : "left";
            const loserSong = currentSongs[loserSide];
            
            document.getElementById(`side-${side}`).classList.add("winner");
            document.getElementById(`side-${loserSide}`).classList.add("loser");
            document.getElementById(`side-${side}`).classList.remove("playing");
            document.getElementById(`side-${loserSide}`).classList.remove("playing");
            
            playAudio(winnerSong, 10, preloadedAudio[side]);
            
            try {
                const response = await fetch(`https://wouldyourathermusic.pythonanywhere.com/vote?mode=${currentGameMode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        winner_id: winnerSong.id,
                        winner_title: winnerSong.title,
                        winner_artist: winnerSong.artist,
                        loser_id: loserSong.id,
                        loser_title: loserSong.title,
                        loser_artist: loserSong.artist
                    })
                });
                if (!response.ok) throw new Error('Falha na resposta do servidor');
                const approvalData = await response.json();
                animateApprovalRating(approvalLeft, approvalData[String(currentSongs.left.id)].approval);
                animateApprovalRating(approvalRight, approvalData[String(currentSongs.right.id)].approval);
            } catch (error) {
                console.error("Erro ao registrar voto:", error);
                approvalLeft.innerText = currentTexts.approval_error;
                approvalRight.innerText = currentTexts.approval_error;
                approvalLeft.style.opacity = 1;
                approvalRight.style.opacity = 1;
            }
            setTimeout(() => {
                nextRoundButton.style.display = "block";
                if (replayButtonsEnabled) {
                    replayLeftButton.classList.add('visible', 'result-visible');
                    replayRightButton.classList.add('visible', 'result-visible');
                }
            }, 1500);
        }
    }
    
    function handleReplay(side, button) {
        if (isReplayActive || button.classList.contains('cooldown')) return;

        isReplayActive = true;
        button.classList.add('cooldown');
        const otherButton = side === 'left' ? replayRightButton : replayLeftButton;
        otherButton.classList.add('cooldown');

        const song = currentSongs[side];
        const audio = preloadedAudio[side];
        
        playAudio(song, 10, audio);
        
        setTimeout(() => {
            isReplayActive = false;
            button.classList.remove('cooldown');
            otherButton.classList.remove('cooldown');
        }, 10000);
    }
    
    replayLeftButton.addEventListener('click', (e) => {
        e.stopPropagation();
        handleReplay('left', replayLeftButton);
    });
    replayRightButton.addEventListener('click', (e) => {
        e.stopPropagation();
        handleReplay('right', replayRightButton);
    });

    sideLeft.addEventListener("click", () => handleChoice("left"));
    sideRight.addEventListener("click", () => handleChoice("right"));
    nextRoundButton.addEventListener("click", startRound);
    startButton.addEventListener("click", () => {
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        startButton.style.display = "none";
        startRound();
    });
    
    replayToggle.addEventListener('change', () => {
        replayButtonsEnabled = replayToggle.checked;
        localStorage.setItem('replayEnabled', replayButtonsEnabled);
        updateReplayStatusText();
    });

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        let lang = urlParams.get('lang');
        if (!translations[lang]) {
            const browserLang = navigator.language.split('-')[0];
            lang = translations[browserLang] ? browserLang : 'pt';
        }
        setLanguage(lang);

        const savedMode = localStorage.getItem('gameMode');
        if (savedMode) {
            currentGameMode = savedMode;
        }
        updateSelectedModeUI();

        const savedVolume = localStorage.getItem('gameVolume');
        if (savedVolume !== null) {
            currentVolume = parseFloat(savedVolume);
        }
        volumeSlider.value = currentVolume * 100;
        volumeValueDisplay.textContent = Math.round(currentVolume * 100);

        const savedReplayPref = localStorage.getItem('replayEnabled');
        if (savedReplayPref === 'true') {
            replayToggle.checked = true;
            replayButtonsEnabled = true;
        }
        updateReplayStatusText();
    });
    </script>
</body>
</html>
