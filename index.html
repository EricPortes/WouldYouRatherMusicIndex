<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Would You Rather? Music</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; }
        .game-container { display: flex; flex-direction: row; width: 100%; height: 100%; position: relative; }
        .divider { width: 10px; height: 100%; background-color: black; position: absolute; top: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
        .vs-circle { width: 100px; height: 100px; background-color: black; border-radius: 50%; color: white; font-size: 48px; font-weight: bold; display: flex; justify-content: center; align-items: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3; border: 5px solid white; }
        .side { width: 50%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: filter 0.3s ease-in-out; }
        .side.left { background-color: #007BFF; }
        .side.right { background-color: #E60023; }
        .side::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.3); opacity: 0; transition: opacity 0.3s ease-in-out; z-index: 0; }
        .side:hover::after { opacity: 1; }
        .song-content { text-align: center; color: white; position: relative; z-index: 1; opacity: 0; transform: scale(0.8); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
        .song-content.visible { opacity: 1; transform: scale(1); }
        .side.winner .song-content { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5)); }
        .side.loser .song-content { opacity: 0.6; transform: scale(0.95); }
        .album-cover { width: 300px; height: 300px; object-fit: cover; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; background-color: #333; }
        .song-title { font-size: 28px; font-weight: bold; }
        .song-artist { font-size: 18px; }
        .approval-rating { font-size: 22px; font-weight: bold; margin-top: 15px; color: white; opacity: 0; transition: opacity 0.5s ease-in; }
        #start-button, #next-round-button { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 15px 30px; font-size: 20px; font-weight: bold; color: white; background-color: #1DB954; border: none; border-radius: 30px; cursor: pointer; z-index: 5; }
        #next-round-button { display: none; }

        @media (max-width: 768px) and (orientation: portrait) {
            .game-container { flex-direction: column; }
            .side { width: 100%; height: 50%; }
            .divider { width: 100%; height: 8px; top: 50%; left: 0; transform: translateY(-50%); }
            .vs-circle { width: 60px; height: 60px; font-size: 28px; border-width: 3px; }
            .album-cover { width: 120px; height: 120px; margin-bottom: 10px; }
            .song-title { font-size: 18px; }
            .song-artist { font-size: 14px; }
            .approval-rating { font-size: 16px; margin-top: 8px; }
            #start-button, #next-round-button { font-size: 16px; padding: 10px 20px; bottom: 20px; }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .vs-circle { width: 60px; height: 60px; font-size: 28px; border-width: 3px; }
            .album-cover { width: 120px; height: 120px; margin-bottom: 10px; }
            .song-title { font-size: 18px; }
            .song-artist { font-size: 14px; }
            .approval-rating { font-size: 16px; margin-top: 8px; }
            #start-button, #next-round-button { font-size: 14px; padding: 8px 16px; bottom: 15px; }
        }

        #menu-toggle { position: absolute; top: 20px; left: 20px; z-index: 10; cursor: pointer; background: none; border: none; padding: 10px; }
        #menu-toggle .bar { display: block; width: 30px; height: 3px; background-color: white; margin: 6px 0; transition: 0.4s; }
        #side-menu {
            position: fixed; top: 0; left: 0; height: 100%;
            width: 250px;
            background-color: #181818; z-index: 1000;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            padding: 20px; box-sizing: border-box; color: white;
            display: flex; flex-direction: column;
            overflow-y: auto; /* <-- CORRE√á√ÉO APLICADA AQUI */
        }
        #side-menu.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .menu-section h2 { margin-top: 20px; margin-bottom: 10px; font-size: 18px; color: #fff; border-bottom: 1px solid #444; padding-bottom: 8px;}
        .menu-section:first-child h2 { margin-top: 40px; }
        #side-menu ul { list-style: none; padding: 0; margin: 0;}
        #side-menu ul li a {
            color: #b3b3b3; text-decoration: none; font-size: 16px;
            padding: 12px 10px; display: block; transition: color 0.2s, background-color 0.2s;
            border-radius: 5px;
        }
        #side-menu ul li a:hover { color: white; background-color: #282828; }
        #side-menu ul li a.selected { color: white; font-weight: bold; background-color: #333; }

        .deezer-credit { margin-top: auto; font-size: 12px; color: #888; padding-top: 20px; }
        .deezer-credit a { color: #888; }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        #menu-overlay.visible { opacity: 1; visibility: visible; }
        
        .volume-control { display: flex; align-items: center; padding: 10px 0; }
        .volume-icon { margin-right: 15px; font-size: 20px; }
        .volume-slider-container { flex-grow: 1; }
        #volume-slider { width: 100%; -webkit-appearance: none; background: transparent; }
        #volume-slider:focus { outline: none; }
        #volume-slider::-webkit-slider-runnable-track { width: 100%; height: 5px; cursor: pointer; background: #535353; border-radius: 5px; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; cursor: pointer; margin-top: -5.5px; box-shadow: 0 0 2px rgba(0,0,0,0.5); }
        #volume-slider::-moz-range-track { width: 100%; height: 5px; cursor: pointer; background: #535353; border-radius: 5px; }
        #volume-slider::-moz-range-thumb { height: 16px; width: 16px; border-radius: 50%; background: #fff; cursor: pointer; border: none; }
        .volume-value { margin-left: 15px; font-size: 16px; min-width: 25px; text-align: right; }

        @media (max-width: 768px) {
            #side-menu { width: 70%; }
        }
    </style>
</head>
<body>
    <button id="menu-toggle">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </button>

    <nav id="side-menu">
        <div class="menu-section">
            <h2 id="menu-title-mode">Modo de Jogo</h2>
            <ul id="game-modes-list">
                <li><a href="#" data-mode="geral">Geral</a></li>
                <li><a href="#" data-mode="pop">Pop</a></li>
                <li><a href="#" data-mode="rock">Rock</a></li>
                <li><a href="#" data-mode="rap">Rap</a></li>
                <li><a href="#" data-mode="eletronica">Eletr√¥nica</a></li>
                <li><a href="#" data-mode="classica">Cl√°ssica</a></li>
            </ul>
        </div>

        <div class="menu-section">
            <h2 id="menu-title-options">Op√ß√µes</h2>
            <h3 id="menu-title-volume" style="color:#b3b3b3; font-size: 14px; margin-top: 15px;">Volume</h3>
            <div class="volume-control">
                <span class="volume-icon">üîä</span>
                <div class="volume-slider-container">
                    <input type="range" min="0" max="100" value="100" id="volume-slider">
                </div>
                <span class="volume-value" id="volume-value-display">100</span>
            </div>
            
            <h3 id="menu-title-language" style="color:#b3b3b3; font-size: 14px; margin-top: 15px;">Idioma</h3>
            <ul id="lang-switcher">
                <li><a href="#" data-lang="en">English</a></li>
                <li><a href="#" data-lang="fr">Fran√ßais</a></li> <li><a href="#" data-lang="es">Espa√±ol</a></li>
                <li><a href="#" data-lang="pt">Portugu√™s</a></li>
            </ul>
        </div>
        
        <div class="deezer-credit">
            <p>Music data provided by</p>
            <a href="https://www.deezer.com" target="_blank" rel="noopener noreferrer">
                <img src="/static/Horizontal-cw-rgb.png" alt="Deezer Logo" height="20">
            </a>
        </div>
    </nav>
    <div id="menu-overlay"></div>

    <div class="game-container">
        <div class="side left" id="side-left"><div class="song-content" id="song-left"><img class="album-cover" id="cover-left" alt=""><h2 class="song-title" id="title-left"></h2><p class="song-artist" id="artist-left"></p><div class="approval-rating" id="approval-left"></div></div></div>
        <div class="vs-circle" id="vs-circle">VS</div>
        <div class="side right" id="side-right"><div class="song-content" id="song-right"><img class="album-cover" id="cover-right" alt=""><h2 class="song-title" id="title-right"></h2><p class="song-artist" id="artist-right"></p><div class="approval-rating" id="approval-right"></div></div></div>
    </div>
    <button id="start-button"></button>
    <button id="next-round-button"></button>
    
    <audio id="audio-player"></audio>

    <script>
    const translations = {
        "pt": {
            menu_mode: "Modo de Jogo", menu_options: "Op√ß√µes", menu_volume: "Volume", menu_language: "Idioma", lang_code: "pt-br", start_game: "‚ñ∂ Iniciar Jogo", next_round: "Pr√≥xima Rodada", approval_of: "Aprova√ß√£o de", vs: "VS", approval_error: "Aprova√ß√£o: Tente Novamente", error_loading_songs: "N√£o foi poss√≠vel carregar as m√∫sicas. Verifique a conex√£o do servidor.", mode_geral: "Geral", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Eletr√¥nica", mode_classica: "Cl√°ssica"
        },
        "en": {
            menu_mode: "Game Mode", menu_options: "Options", menu_volume: "Volume", menu_language: "Language", lang_code: "en", start_game: "‚ñ∂ Start Game", next_round: "Next Round", approval_of: "Approval Rating", vs: "VS", approval_error: "Approval: Try Again Later", error_loading_songs: "Couldn't load songs. Please check the server connection.", mode_geral: "General", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Electronic", mode_classica: "Classical"
        },
        "es": {
            menu_mode: "Modo de Juego", menu_options: "Opciones", menu_volume: "Volumen", menu_language: "Idioma", lang_code: "es", start_game: "‚ñ∂ Iniciar Juego", next_round: "Siguiente Ronda", approval_of: "√çndice de Aprobaci√≥n", vs: "VS", approval_error: "Aprobaci√≥n: Int√©ntalo m√°s tarde", error_loading_songs: "No se pudieron cargar las canciones. Comprueba la conexi√≥n del servidor.", mode_geral: "General", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "Electr√≥nica", mode_classica: "Cl√°sica"
        },
        "fr": { // <-- TRADU√á√ÉO PARA FRANC√äS ADICIONADA
            menu_mode: "Mode de jeu", menu_options: "Options", menu_volume: "Volume", menu_language: "Langue", lang_code: "fr", start_game: "‚ñ∂ D√©marrer le jeu", next_round: "Tour suivant", approval_of: "Taux d'approbation", vs: "VS", approval_error: "Approbation : R√©essayez plus tard", error_loading_songs: "Impossible de charger les chansons. V√©rifiez la connexion au serveur.", mode_geral: "G√©n√©ral", mode_pop: "Pop", mode_rock: "Rock", mode_rap: "Rap", mode_eletronica: "√âlectronique", mode_classica: "Classique"
        }
    };

    let currentTexts = {};
    const startButton = document.getElementById("start-button");
    const nextRoundButton = document.getElementById("next-round-button");
    const vsCircle = document.getElementById("vs-circle");
    const menuTitleMode = document.getElementById("menu-title-mode");
    const menuTitleOptions = document.getElementById("menu-title-options");
    const menuTitleVolume = document.getElementById("menu-title-volume");
    const menuTitleLanguage = document.getElementById("menu-title-language");
    const menuToggle = document.getElementById('menu-toggle');
    const sideMenu = document.getElementById('side-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const langSwitcher = document.getElementById('lang-switcher');
    const sideLeft = document.getElementById("side-left");
    const sideRight = document.getElementById("side-right");
    const songLeft = document.getElementById("song-left");
    const songRight = document.getElementById("song-right");
    const approvalLeft = document.getElementById("approval-left");
    const approvalRight = document.getElementById("approval-right");
    const gameModesList = document.getElementById('game-modes-list');
    const volumeSlider = document.getElementById('volume-slider');
    const volumeValueDisplay = document.getElementById('volume-value-display');

    let currentSongs = {};
    let roundOver = false;
    let isChoiceEnabled = false;
    let currentGameMode = 'geral'; 
    let currentVolume = 1.0;
    let revealTimeoutId = null;

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContext();
    let currentAudioSource = null;
    let currentGainNode = null;

    function playAudio(song, durationInSeconds) {
        if (currentAudioSource) {
            try { currentAudioSource.stop(); } catch (e) {}
        }
        if (!song || !song.preview) {
            return;
        }

        fetch(song.preview)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                currentAudioSource = audioContext.createBufferSource();
                currentGainNode = audioContext.createGain();
                currentAudioSource.buffer = audioBuffer;
                currentAudioSource.connect(currentGainNode);
                currentGainNode.connect(audioContext.destination);
                
                const startOffset = song.startOffset || 0;
                const initialVolume = currentVolume;

                currentGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                currentGainNode.gain.linearRampToValueAtTime(initialVolume, audioContext.currentTime + 1);
                currentAudioSource.start(audioContext.currentTime, startOffset);

                const fadeOutTime = audioContext.currentTime + durationInSeconds - 1;
                currentGainNode.gain.setValueAtTime(initialVolume, fadeOutTime);
                currentGainNode.gain.linearRampToValueAtTime(0, fadeOutTime + 1);
                currentAudioSource.stop(fadeOutTime + 1.1);
            })
            .catch(e => console.error("Erro ao processar √°udio:", e));
    }

    function setLanguage(lang) {
        currentTexts = translations[lang] || translations['pt'];
        document.documentElement.lang = currentTexts.lang_code;
        startButton.innerText = currentTexts.start_game;
        nextRoundButton.innerText = currentTexts.next_round;
        vsCircle.innerText = currentTexts.vs;
        menuTitleMode.innerText = currentTexts.menu_mode;
        menuTitleOptions.innerText = currentTexts.menu_options;
        menuTitleVolume.innerText = currentTexts.menu_volume;
        menuTitleLanguage.innerText = currentTexts.menu_language;

        document.querySelectorAll('#game-modes-list a').forEach(link => {
            const mode = link.dataset.mode;
            const translationKey = `mode_${mode}`;
            if (currentTexts[translationKey]) {
                link.innerText = currentTexts[translationKey];
            }
        });
    }
    
    function updateSelectedModeUI() {
        document.querySelectorAll('#game-modes-list a').forEach(a => {
            if (a.dataset.mode === currentGameMode) {
                a.classList.add('selected');
            } else {
                a.classList.remove('selected');
            }
        });
    }

    function toggleMenu() {
        sideMenu.classList.toggle('open');
        menuOverlay.classList.toggle('visible');
    }

    async function startRound() {
        clearTimeout(revealTimeoutId);
        roundOver = false;
        isChoiceEnabled = false;
        nextRoundButton.style.display = "none";
        songLeft.classList.remove("visible");
        songRight.classList.remove("visible");
        sideLeft.classList.remove("winner", "loser");
        sideRight.classList.remove("winner", "loser");
        approvalLeft.style.opacity = 0;
        approvalRight.style.opacity = 0;
        try {
            const response = await fetch(`https://wouldyourathermusic.pythonanywhere.com/get-songs?mode=${currentGameMode}`);
            const data = await response.json();
            if (data.error) {
                return alert(currentTexts.error_loading_songs);
            }
            currentSongs.left = data[0];
            currentSongs.right = data[1];
            prepareSide("left", currentSongs.left);
            prepareSide("right", currentSongs.right);
            revealLeft();
        } catch (error) {
            console.error("N√£o foi poss√≠vel buscar as m√∫sicas:", error);
            alert(currentTexts.error_loading_songs);
        }
    }

    function prepareSide(side, song) {
        const coverEl = document.getElementById(`cover-${side}`);
        coverEl.src = song.cover;
        coverEl.alt = `Capa do √°lbum ${song.title} de ${song.artist}`;
        document.getElementById(`title-${side}`).innerText = song.title;
        document.getElementById(`artist-${side}`).innerText = song.artist;
    }

    function revealLeft() {
        songLeft.classList.add("visible");
        playAudio(currentSongs.left, 5);
        revealTimeoutId = setTimeout(revealRight, 5500);
    }

    function revealRight() {
        if (roundOver) return;
        songRight.classList.add("visible");
        playAudio(currentSongs.right, 5);
        revealTimeoutId = setTimeout(() => {
            if (!roundOver) { isChoiceEnabled = true; }
        }, 5000);
    }

    function animateApprovalRating(element, finalValue) {
        element.style.opacity = 1;
        let startValue = 0;
        const duration = 1000;
        const stepTime = 20;
        const steps = duration / stepTime;
        let increment = finalValue === 0 ? 0 : finalValue / steps;
        
        element.innerText = `${currentTexts.approval_of} 0%`;
        if (finalValue === 0) return;

        const timer = setInterval(() => {
            startValue += increment;
            if (startValue >= finalValue) {
                startValue = finalValue;
                clearInterval(timer);
            }
            element.innerText = `${currentTexts.approval_of} ${Math.floor(startValue)}%`;
        }, stepTime);
    }

    async function handleChoice(side) {
        if (!roundOver && isChoiceEnabled) {
            roundOver = true;
            isChoiceEnabled = false;
            const winnerSong = currentSongs[side];
            const loserSide = "left" === side ? "right" : "left";
            const loserSong = currentSongs[loserSide];
            document.getElementById(`side-${side}`).classList.add("winner");
            document.getElementById(`side-${loserSide}`).classList.add("loser");
            playAudio(winnerSong, 10);
            try {
                const response = await fetch(`https://wouldyourathermusic.pythonanywhere.com/vote?mode=${currentGameMode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        winner_id: winnerSong.id,
                        winner_title: winnerSong.title,
                        winner_artist: winnerSong.artist,
                        loser_id: loserSong.id,
                        loser_title: loserSong.title,
                        loser_artist: loserSong.artist
                    })
                });
                if (!response.ok) throw new Error('Falha na resposta do servidor');
                const approvalData = await response.json();
                animateApprovalRating(approvalLeft, approvalData[String(currentSongs.left.id)].approval);
                animateApprovalRating(approvalRight, approvalData[String(currentSongs.right.id)].approval);
            } catch (error) {
                console.error("Erro ao registrar voto:", error);
                approvalLeft.innerText = currentTexts.approval_error;
                approvalRight.innerText = currentTexts.approval_error;
                approvalLeft.style.opacity = 1;
                approvalRight.style.opacity = 1;
            }
            setTimeout(() => {
                nextRoundButton.style.display = "block";
            }, 1500);
        }
    }
    
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);

    langSwitcher.addEventListener('click', (event) => {
        if (event.target.tagName === 'A') {
            event.preventDefault();
            const selectedLang = event.target.getAttribute('data-lang');
            window.location.href = window.location.pathname + '?lang=' + selectedLang;
        }
    });

    gameModesList.addEventListener('click', (event) => {
        event.preventDefault();
        const target = event.target.closest('a');
        if (target) {
            const newMode = target.dataset.mode;
            if (newMode !== currentGameMode) {
                currentGameMode = newMode;
                localStorage.setItem('gameMode', currentGameMode);
                updateSelectedModeUI();
                startButton.style.display = "none";
                startRound();
            }
            toggleMenu();
        }
    });

    volumeSlider.addEventListener('input', (event) => {
        const volumeValue = parseInt(event.target.value, 10);
        currentVolume = volumeValue / 100;
        volumeValueDisplay.textContent = volumeValue;
        if (currentGainNode) {
            currentGainNode.gain.setValueAtTime(currentVolume, audioContext.currentTime);
        }
        localStorage.setItem('gameVolume', currentVolume);
    });

    sideLeft.addEventListener("click", () => handleChoice("left"));
    sideRight.addEventListener("click", () => handleChoice("right"));
    nextRoundButton.addEventListener("click", startRound);
    startButton.addEventListener("click", () => {
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        startButton.style.display = "none";
        startRound();
    });

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        let lang = urlParams.get('lang');
        if (!translations[lang]) {
            const browserLang = navigator.language.split('-')[0];
            lang = translations[browserLang] ? browserLang : 'pt';
        }
        setLanguage(lang);

        const savedMode = localStorage.getItem('gameMode');
        if (savedMode) {
            currentGameMode = savedMode;
        }
        updateSelectedModeUI();

        const savedVolume = localStorage.getItem('gameVolume');
        if (savedVolume !== null) {
            currentVolume = parseFloat(savedVolume);
        }
        volumeSlider.value = currentVolume * 100;
        volumeValueDisplay.textContent = Math.round(currentVolume * 100);
    });
    </script>
</body>
</html>
